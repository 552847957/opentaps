/*
 * Copyright (c) 2010 - 2011 Open Source Strategies, Inc.
 *
 * Opentaps is free software: you can redistribute it and/or modify it
 * under the terms of the GNU Affero General Public License as published
 * by the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Opentaps is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Opentaps.  If not, see <http://www.gnu.org/licenses/>.
 */
package com.opensourcestrategies.activities.reports;

import org.jfree.chart.ChartFactory;
import org.jfree.chart.JFreeChart;
import org.jfree.chart.axis.AxisLocation;
import org.jfree.chart.axis.CategoryAxis;
import org.jfree.chart.axis.CategoryLabelPositions;
import org.jfree.chart.axis.NumberAxis;
import org.jfree.chart.plot.CategoryPlot;
import org.jfree.chart.plot.PlotOrientation;
import org.jfree.chart.renderer.category.BarRenderer;
import org.jfree.chart.servlet.ServletUtilities;
import org.jfree.data.category.DefaultCategoryDataset;
import org.jfree.ui.RectangleInsets;
import org.ofbiz.entity.GenericEntityException;
import org.ofbiz.entity.GenericValue;
import org.opentaps.common.util.UtilMessage;

import java.awt.*;
import java.io.IOException;
import java.math.BigDecimal;
import java.sql.Timestamp;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.Iterator;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.TimeZone;
import org.jfree.data.category.IntervalCategoryDataset;
import org.jfree.data.gantt.Task;
import org.jfree.data.gantt.TaskSeries;
import org.jfree.data.gantt.TaskSeriesCollection;
import org.jfree.data.xy.XYDataset;
import org.jfree.data.xy.XYSeriesCollection;
import org.ofbiz.base.util.Debug;
import org.ofbiz.base.util.UtilDateTime;
import org.ofbiz.entity.GenericDelegator;
import org.ofbiz.entity.condition.EntityCondition;
import org.ofbiz.entity.condition.EntityOperator;
import org.opentaps.base.entities.ActivityFact;
import org.opentaps.domain.DomainsLoader;
import org.opentaps.domain.party.PartyRepositoryInterface;
import org.opentaps.foundation.entity.Entity;
import org.opentaps.foundation.infrastructure.Infrastructure;
import org.opentaps.foundation.infrastructure.User;
import org.opentaps.foundation.repository.RepositoryException;
import org.opentaps.foundation.service.Service;
import org.ofbiz.service.LocalDispatcher;
import org.opentaps.base.entities.DateDim;
import org.opentaps.common.reporting.etl.UtilEtl;

/**
 * Charts for Financials generated by the JFree API.
 */
public class JFreeActivitiesCharts extends Service{
    
    private static String MODULE = JFreeActivitiesCharts.class.getName();
    
    
    public static String createActivitiesByLeadSnapshotChart(int cutoffDays, Locale locale, LocalDispatcher dispatcher, GenericValue user, TimeZone timeZone) throws Exception{
        Map<String, Object> uiLabelMap = UtilMessage.getUiLabels(locale);
        DomainsLoader domainLoader = new DomainsLoader(new Infrastructure(dispatcher), new User(user));
        PartyRepositoryInterface rep = domainLoader.getDomainsDirectory().getPartyDomain().getPartyRepository();
        final DefaultCategoryDataset dataset = new DefaultCategoryDataset();

        //Get date dimension ID according to the work effort start date.

        UtilEtl.setupDateDimension(rep.getInfrastructure().getDelegator(), timeZone, locale);
        Timestamp readingDate = UtilDateTime.nowTimestamp();// TODO: substract cutoffdays

        DateFormat dayOfMonthFmt = new SimpleDateFormat("dd");
        DateFormat monthOfYearFmt = new SimpleDateFormat("MM");
        DateFormat yearNumberFmt = new SimpleDateFormat("yyyy");
        String dayOfMonth = dayOfMonthFmt.format(readingDate);
        String monthOfYear = monthOfYearFmt.format(readingDate);
        String yearNumber = yearNumberFmt.format(readingDate);

        EntityCondition dateDimConditions = EntityCondition.makeCondition(EntityOperator.AND,
        EntityCondition.makeCondition(DateDim.Fields.dayOfMonth.name(), dayOfMonth),
        EntityCondition.makeCondition(DateDim.Fields.monthOfYear.name(), monthOfYear),
        EntityCondition.makeCondition(DateDim.Fields.yearNumber.name(), yearNumber));

        Long readingDateDimId = UtilEtl.lookupDimension(DateDim.class.getSimpleName(), DateDim.Fields.dateDimId.getName(), dateDimConditions, rep.getInfrastructure().getDelegator());

        //Long readingDateDimId = Long.valueOf(14780);
        EntityCondition cond = null;
        List<ActivityFact> prospectActivityFacts = rep.findList(ActivityFact.class, cond);
        Map<String, List<ActivityFact>> leads = Entity.groupByFieldValues(String.class, prospectActivityFacts, ActivityFact.Fields.targetPartyId);

        Iterator it = leads.keySet().iterator();
        while(it.hasNext() == true){
           String targetPartyId = (String) it.next();
           List<ActivityFact> activities = leads.get(targetPartyId);

           long oldActivityCount = 0;
           long newActivityCount = 0;
           for(int i = 0; i < activities.size(); i++){
               ActivityFact targetActivity = activities.get(i);

               if(targetActivity.getDateDimId() < readingDateDimId){
                   oldActivityCount = oldActivityCount + 
                                     targetActivity.getPhoneCallActivityCount() + 
                                     targetActivity.getEmailActivityCount() + 
                                     targetActivity.getVisitActivityCount() + 
                                     targetActivity.getOtherActivityCount();
               }

               if(targetActivity.getDateDimId() >= readingDateDimId){
                   newActivityCount = newActivityCount + 
                                     targetActivity.getPhoneCallActivityCount() + 
                                     targetActivity.getEmailActivityCount() + 
                                     targetActivity.getVisitActivityCount() + 
                                     targetActivity.getOtherActivityCount();
               }
           }

           dataset.addValue(oldActivityCount, (String) uiLabelMap.get("LeadManagementOldActivities"), targetPartyId);
           dataset.addValue(newActivityCount, (String) uiLabelMap.get("LeadManagementRecentActivities"), targetPartyId);
        }

        Debug.logInfo("cutoffDays = "+cutoffDays, MODULE);      

        // set up the chart
        JFreeChart chart = ChartFactory.createBarChart(
                (String) uiLabelMap.get("LeadManagementActivityOfLeadsSnapshot"),     // chart title
                (String) uiLabelMap.get("LeadManagementLead"),               // domain axis label
                (String) uiLabelMap.get("LeadManagementActivity"),           // range axis label
                dataset,                                                    // data
                PlotOrientation.HORIZONTAL,                                   // orientation
                true,                                                      // include legend
                true,                                                       // tooltips
                false                                                       // urls
        );
        chart.setBackgroundPaint(Color.white);
        chart.setBorderVisible(true);
        chart.setPadding(new RectangleInsets(5.0, 5.0, 5.0, 5.0));

        // get a reference to the plot for further customisation...
        final CategoryPlot plot = chart.getCategoryPlot();
        plot.setRangeAxisLocation(AxisLocation.BOTTOM_OR_LEFT);

        // get the bar renderer to put effects on the bars
        final BarRenderer renderer = (BarRenderer) plot.getRenderer();
        renderer.setDrawBarOutline(false); // disable bar outlines

        // set up gradient paint on bar
        final GradientPaint gp = new GradientPaint(
            0.0f, 0.0f, Color.GREEN,
            0.0f, 0.0f, Color.GRAY
        );
        renderer.setSeriesPaint(0, gp);

        // change the auto tick unit selection to integer units only...
        final NumberAxis rangeAxis = (NumberAxis) plot.getRangeAxis();
        rangeAxis.setStandardTickUnits(NumberAxis.createIntegerTickUnits());

        // tilt the category labels so they fit
        CategoryAxis domainAxis = plot.getDomainAxis();
        domainAxis.setCategoryLabelPositions(
            CategoryLabelPositions.createUpRotationLabelPositions(Math.PI / 6.0)
        );

        // save as a png and return the file name
        return ServletUtilities.saveChartAsPNG(chart, 400, 300, null);
    }

    public static String createActivitiesBySalesRepSnapshotChart(){
        return null;
    }
    
   

}
